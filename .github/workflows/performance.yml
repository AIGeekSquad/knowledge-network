name: Performance Testing

on:
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  performance:
    name: Performance Regression Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          PUPPETEER_SKIP_DOWNLOAD: 'true'

      - name: Build packages
        run: pnpm build

      - name: Run performance tests
        run: |
          echo "## üìä Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Bundle Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size | Gzipped |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|---------|" >> $GITHUB_STEP_SUMMARY
          
          # Core library sizes
          for file in packages/knowledge-network/dist/*.js; do
            if [[ ! "$file" =~ \.map$ ]]; then
              SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
              SIZE_KB=$(echo "scale=2; $SIZE / 1024" | bc)
              GZIP_SIZE=$(gzip -c "$file" | wc -c)
              GZIP_KB=$(echo "scale=2; $GZIP_SIZE / 1024" | bc)
              BASENAME=$(basename "$file")
              echo "| $BASENAME | ${SIZE_KB}KB | ${GZIP_KB}KB |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Time" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Measure build time
          START_TIME=$(date +%s)
          pnpm build
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          
          echo "‚è±Ô∏è Build completed in ${BUILD_TIME}s" >> $GITHUB_STEP_SUMMARY

      - name: Check bundle size limits
        run: |
          # Set thresholds (in bytes)
          MAX_ESM_SIZE=$((300 * 1024))  # 300KB
          MAX_CJS_SIZE=$((300 * 1024))  # 300KB
          
          ESM_SIZE=$(stat -c%s packages/knowledge-network/dist/index.js 2>/dev/null || stat -f%z packages/knowledge-network/dist/index.js)
          CJS_SIZE=$(stat -c%s packages/knowledge-network/dist/index.cjs 2>/dev/null || stat -f%z packages/knowledge-network/dist/index.cjs)
          
          echo "ESM bundle size: $ESM_SIZE bytes (limit: $MAX_ESM_SIZE bytes)"
          echo "CJS bundle size: $CJS_SIZE bytes (limit: $MAX_CJS_SIZE bytes)"
          
          if [ $ESM_SIZE -gt $MAX_ESM_SIZE ]; then
            echo "‚ö†Ô∏è ESM bundle size exceeds limit!"
            exit 1
          fi
          
          if [ $CJS_SIZE -gt $MAX_CJS_SIZE ]; then
            echo "‚ö†Ô∏è CJS bundle size exceeds limit!"
            exit 1
          fi
          
          echo "‚úÖ Bundle sizes are within limits"

  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          PUPPETEER_SKIP_DOWNLOAD: 'true'

      - name: Build demo site
        run: pnpm build

      - name: Start demo server
        run: cd packages/demo-suite && pnpm preview &
        env:
          CI: true

      - name: Wait for server
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:4173; do sleep 2; done'

      - name: Run Lighthouse
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:4173
          uploadArtifacts: true
          temporaryPublicStorage: true
